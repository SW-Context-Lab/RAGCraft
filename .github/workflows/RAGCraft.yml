name: RAGCraft CD Pipeline

on:
  push:
    branches: [ "main" ]   # main 브랜치에 코드가 들어오면 자동 실행

jobs:
  deploy:
    runs-on: ubuntu-latest # GitHub가 제공하는 Ubuntu 러너 사용

    steps:
      # 1. GitHub 레포지토리 코드를 러너에 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 빌드를 위해 Java 17 환경 설치
      #    (이 Java는 GitHub 러너에서만 사용됨)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'        # Java 버전
          distribution: 'temurin'   # OpenJDK 배포판

      # 3. Spring Boot JAR 빌드
      #    build.gradle이 ragcraft 폴더 안에 있으므로 작업 디렉터리 지정
      - name: Build Spring Boot JAR
        working-directory: ragcraft
        run: ./gradlew clean bootJar

      # 4. 빌드된 JAR 파일을 EC2 서버로 전송
      - name: Upload JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.EC2_HOST }}        # EC2 주소
          username: ${{ vars.EC2_USER }}    # EC2 사용자
          key: ${{ secrets.EC2_SSH_KEY }}   # SSH 개인키 (Secrets)
          source: "ragcraft/build/libs/*.jar" # 빌드 결과 JAR 경로
          target: "/home/ubuntu/ragcraft"   # EC2의 배포 디렉터리
          strip_components: 3

      # 5. EC2에서 환경변수 파일(.env) 갱신 + 서비스 재시작
      - name: Update env file and restart service
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_URL: ${{ secrets.DB_URL }}           # DB 주소
          DB_USERNAME: ${{ secrets.DB_USERNAME }} # DB 계정
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }} # DB 비밀번호
          ES_HOST: ${{ secrets.ES_HOST }} # ES 주소
          ES_API_KEY: ${{ secrets.ES_API_KEY }} # ES API 키
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }} # google 자격증명
          
        with:
          host: ${{ vars.EC2_HOST }}
          username: ${{ vars.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ragcraft 디렉터리로 이동
            cd /home/ubuntu/ragcraft

            # 기존 .env 파일을 새 값으로 덮어씀
            echo "DB_URL=${{ secrets.DB_URL }}" > .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "ES_HOST=${{ secrets.ES_HOST }}" >> .env
            echo "ES_API_KEY=${{ secrets.ES_API_KEY }}" >> .env
            echo "GOOGLE_APPLICATION_CREDENTIALS=${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" >> .env

            # JAR 파일명을 고정 이름으로 변경
            mv ragcraft-*.jar ragcraft.jar

            # systemd 설정 다시 로드
            sudo systemctl daemon-reload

            # 서비스 재시작
            sudo systemctl restart ragcraft

